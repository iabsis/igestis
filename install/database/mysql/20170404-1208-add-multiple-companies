CREATE TABLE IF NOT EXISTS `CORE_ASSOC_USERS_COMPANIES` (
  `user_id` mediumint(9) NOT NULL,
  `company_id` mediumint(9) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

ALTER TABLE `CORE_ASSOC_USERS_COMPANIES`
 ADD PRIMARY KEY (`user_id`,`company_id`), ADD KEY `company_id` (`company_id`), ADD KEY `user_id` (`user_id`);

ALTER TABLE `CORE_ASSOC_USERS_COMPANIES`
ADD CONSTRAINT `CORE_ASSOC_USERS_COMPANIES_ibfk_2` FOREIGN KEY (`company_id`) REFERENCES `CORE_COMPANIES` (`id`) ON DELETE CASCADE ON UPDATE CASCADE;

INSERT INTO `CORE_ASSOC_USERS_COMPANIES` (user_id, company_id)
SELECT id, company_id FROM CORE_USERS WHERE company_id IS NOT NULL;
